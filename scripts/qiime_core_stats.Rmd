---
title: "tss_core_stats"
author: "Madi"
date: "2023-05-25"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(qiime2R)
library(tidyverse)
library(cowplot)
library(magrittr)
library(vegan)
library(viridis)
library(microshades)
library(phyloseq)
library(ggh4x)
library(broom)
library(rstatix)
library(dunn.test)
```

**Basic Functions**
```{r}
## initial metadata fixer 
metadata_fixer <- function(metadata_fp) {
  tmpMeta <- read_tsv(metadata_fp, n_max = 2)
  mycols <- colnames(tmpMeta)
  metadata <- read_tsv(metadata_fp, skip = 2, col_names = mycols)
  names(metadata)[names(metadata) == '#SampleID'] <- 'sampleid'
  metadata %>% 
    filter(!is.na(diet)) %>% 
    mutate(day_post_inf = if_else(day_post_inf == 2, 3, day_post_inf)) %>% 
    mutate(diet = as.factor(diet)) -> metadata
  return(metadata)
}

## next function
## for distance matrix processing
dist_matrix_prep <- function(metadata_file,
                             dist_matrix_fp,
                             sample_filter){ 
  ## metadata filtering
  metadata_file %>% 
    filter(!(sampleid %in% sample_filter)) -> metadata
  ## distance matrix
  dist <- read_tsv(dist_matrix_fp)
  names(dist)[names(dist) == '...1'] <- 'sampleid'
  dist %>% 
    gather(-sampleid, key = sample_col, value = dist) %>% 
    filter(sampleid %in% metadata$sampleid) %>% 
    filter(sample_col %in% metadata$sampleid) %>% 
    spread(sample_col, dist) -> dist_long
  dist_long %>% 
    select(-sampleid) -> dist_proc
  metadata %>% 
    arrange(sampleid) -> metadata
  metadata %>% 
    filter(sampleid %in% dist_long$sampleid) -> filt_meta
  dist_proc <- as.matrix(dist_proc)
  row.names(dist_proc) <- colnames(dist_proc)
  filt_meta <- filt_meta[order(filt_meta$sampleid),]
  ## list of outputs
  my_list <- list(Metadata = filt_meta,
                  DistanceMatrix = dist_proc)
  return(my_list)
}


## for editing my metadata file post metadata fixer 
meta_diet_fixer <- function(metadata_file,
                            seq_depth_fp){
  seq_depths <- read_tsv(seq_depth_fp)
  metadata_file %>% 
    select(sampleid, diet, day_post_inf, mouse_id, study) %>% 
    mutate(diet_true = diet,
    diet_true = if_else(day_post_inf == -15, "Chow", diet_true),
    high_fat = case_when(
      diet_true == 'HF/HF' ~ 1,
      diet_true == 'HF/LF' ~ 1,
      .default = 0
      ), 
      high_fiber = case_when(
      diet_true == 'HF/HF' ~ 1,
      diet_true == 'LF/HF' ~ 1,
      diet_true == 'Chow' ~ 1,
      .default = 0
      ), 
      purified_diet = case_when(
      diet_true == 'Chow' ~ 0,
      .default = 1
      )
    ) %>% 
    left_join(seq_depths) -> metadata
  return(metadata)
}

## beta diversity adonis2 testing function
adonis_test <- function(dist_matrix,
                        metadata_file){
  adonis_results <- adonis2(as.dist(dist_matrix) ~ purified_diet * seq_depth + high_fat + high_fiber +
                        day_post_inf + study,
                        data = metadata_file,
                        permutations = 999, 
                        parallel = 4)
  adonis_results <- tidy(adonis_results)
  return(adonis_results)
}

```

**File paths for all needed files**
Doing this so that I don't have to worry about re-entering entire file paths all the time, they'll just be at the beginning
```{r}
metadata_FP <- '../data/misc/merged_metadata1.tsv'
seq_depth_FP <- '../data/misc/tss_seq_depth.tsv'
uw_dist_fp <- '../data/qiime/core_outputs/uw_dist_matrix.tsv'
w_dist_fp <- '../data/qiime/core_outputs/w_dist_matrix.tsv'
faith_pd_fp <- '../data/qiime/core_outputs/faith_pd.tsv'
shannon_fp <- '../data/qiime/core_outputs/shannon_entropy.tsv'
unwanted_samples <- c('Mock20220615A', 'Mock_1A', 'Mock_2A',
                      'Mock_3A', 'Mock_4A', 'Mock_5A', 'Mock_6A',
                      'Mock_7A', 'PCR Blank0',
                      'PCR Blank1', 'Mock_7', 'Mock_6',
                      'Mock_5', 'Mock_4', 'PCR blank')
```


**Stats on my total sum scaled core metrics**
**prepping all needed files to run the unweighted stats**

```{r}
## testing 
dist_files <- dist_matrix_prep(stat_meta,
                               uw_dist_fp,
                               unwanted_samples)

uw_dist <- dist_files$DistanceMatrix
stat_meta <- dist_files$Metadata

## testing
filt_stat_meta <- meta_diet_fixer(stat_meta,
                                  seq_depth_FP)
## testing 
uw_adonis <- adonis_test(uw_dist,
                         filt_stat_meta)
uw_adonis
```


**unweighted UniFrac Adonis test**
for the unweighted unifrac. takes into account the diet and the days post infection (or relative to infection). I'm not sure what this is telling me yet. Now it's giving me the exact same p-value for everything which isn't what we wanted. I tried by = "terms" in the adonis test but that didn't help either. I'm wondering if we should do something like a kruskal-wallis followed by a dunn test instead of an adonis? 
```{r}

uw_adonis <- adonis2(as.dist(uw_dist) ~ purified_diet * seq_depth + high_fat + high_fiber +
                       day_post_inf + study,
                     data = filt_stat_meta,
                     permutations = 999, 
                     parallel = 4)

uw_adonis <- tidy(uw_adonis)

uw_adonis
```


**prepping weighted UniFrac distance matrix and metadata file**
```{r}

## I had to unzip the qza file because it was telling me that it had duplicate names?
## weighted 
w_dist <- read_tsv(w_dist_fp)
names(w_dist)[names(w_dist) == '...1'] <- 'sampleid'

## filtering the sample ids out that have character names instead of numeric names 
## I thought this was causing the error but its not so rip
## taking distance matrix from wide to long to wide again format
w_dist %>% 
  gather(-sampleid, key = sample_col, value = dist) %>% 
  filter(!(sampleid %in% unwanted_samples)) %>% 
  filter(!(sample_col %in% unwanted_samples)) %>% 
  spread(sample_col, dist) -> w_long

## making sure the number of rows is the same for the distance matrix and the metadata file 
w_long %>% 
  select(-sampleid) -> w_dist

stat_meta %>% 
  arrange(sampleid) -> stat_meta

## making sure the number of rows is the same for the distance matrix and the metadata file 
stat_meta %>% 
  filter(sampleid %in% w_long$sampleid) -> filt_stat_meta

w_dist <- as.matrix(w_dist)
row.names(w_dist) <- colnames(w_dist)

# sort based on alphabetical order of metadata sampleid
filt_stat_meta <- filt_stat_meta[order(filt_stat_meta$sampleid),]

```


**weighted UniFrac Adonis test**
for the weighted unifrac. takes into account the diet and the days post infection (or relative to infection). I'm not sure what this is telling me yet. The data looks much better without the stratification (I'm not sure what that means but I'm excited about it)!
```{r}
w_adonis <- adonis2(as.dist(w_dist) ~ purified_diet * seq_depth + high_fat + high_fiber +
                     day_post_inf + study,
                     data = filt_stat_meta,
                     permutations = 999, 
                     parallel = 4)

w_adonis <- tidy(w_adonis)

w_adonis
```

**non-parametric ANOVAs for my alpha diversity**
need to run a base R kruskal-wallis test followed by a Dunn's post hoc test for both my faith's pd and my shannon entropy

**reading in my needed files for faith's pd**
```{r}
## faith's pd 
# tmp_faith <- read_tsv(faith_pd_fp, 
#                       n_max = 2)
# faith_cols <- colnames(tmp_faith)
# faith_pd <- read_tsv(faith_pd_fp, skip = 2, col_names = faith_cols)
faith_pd <- read_tsv(faith_pd_fp)
names(faith_pd)[names(faith_pd) == '#SampleID'] <- 'sampleid'

unwanted_samples <- c('Mock20220615A', 'Mock_1A', 'Mock_2A', 'Mock_3A', 'Mock_4A', 'Mock_5A', 'Mock_6A', 'Mock_7A', 'PCR Blank0',
                      'PCR Blank1', 'Mock_7', 'Mock_6', 'Mock_5', 'Mock_4', 'PCR blank')

faith_pd %>% 
  filter(!(sampleid %in% unwanted_samples)) -> faith_pd


## metadata file 
stat_meta <- metadata_fixer(metadata_FP)

stat_meta %>% 
  filter(!(sampleid %in% unwanted_samples)) -> stat_meta

## reading in sequencing depth to join with my metadata file 
seq_depth <- read_tsv(seq_depth_fp)

## faith biom table construction 
stat_meta %>% 
  filter(sampleid %in% faith_pd$sampleid) %>% 
  left_join(faith_pd, by = 'sampleid') %>% 
  left_join(seq_depth, by = 'sampleid') %>% 
  select(sampleid, diet, study, day_post_inf, mouse_id, faith_pd, seq_depth) %>% 
  mutate(day_post_inf_fact = as.factor(day_post_inf)) %>% 
  filter(!is.na(diet)) -> faith_biom

```

**faith's pd linear modeling**
this one is with all the diets sectioned out. 
```{r}
## instead of the kruskal-walllis and dunn's post hoc test, we should do this instead 
## need to have my seq_depth file combined with my metadata along with my re-run core metrics 
## should do it with my sectioned out diets 
faith_biom %>%
  do(tidy(lm(faith_pd ~ high_fat + high_fiber + purified_diet + (day_post_inf_fact * seq_depth),
             data = .))) -> sectioned_faith_lm

sectioned_faith_lm

## need to do this for my shannon entropy as well 
```

**faith's pd linear modeling**
this one was done with just diet in general instead of having it sectioned out. 
```{r}
## and just with diet in general 
faith_biom %>%
  do(tidy(lm(faith_pd ~ diet + (day_post_inf_fact * seq_depth),
             data = .))) -> faith_lm

faith_lm
```


**reading in my needed files for shannon entropy**
```{r}
## shannon entropy
shannon <- read_tsv(shannon_fp)
names(shannon)[names(shannon) == '...1'] <- 'sampleid'

unwanted_samples <- c('Mock20220615A', 'Mock_1A', 'Mock_2A', 'Mock_3A', 'Mock_4A', 'Mock_5A', 'Mock_6A', 'Mock_7A', 'PCR Blank0','PCR Blank1', 'Mock_7', 'Mock_6', 'Mock_5', 'Mock_4', 'PCR blank')

shannon %>% 
  filter(!(sampleid %in% unwanted_samples)) -> shannon


## metadata file 
stat_meta <- metadata_fixer(metadata_FP)

stat_meta %>% 
  filter(!(sampleid %in% unwanted_samples)) -> stat_meta

## reading in sequencing depth file
seq_depth <- read_tsv(seq_depth_fp)

## shannon biom table construction 
## have to start by filtering out sampleids that my shannon doesn't have but that my metadata does 
stat_meta %>% 
  filter(sampleid %in% shannon$sampleid) %>% 
  left_join(shannon, by = 'sampleid') %>% 
  left_join(seq_depth, by = 'sampleid') %>% 
  select(sampleid, diet, study, day_post_inf, mouse_id, shannon_entropy, seq_depth) %>% 
  mutate(day_post_inf_fact = as.factor(day_post_inf)) -> shannon_biom


```

**shannon entropy sectioned linear model**
```{r}
shannon_biom %>%
  do(tidy(lm(shannon_entropy ~ high_fat + high_fiber + purified_diet + (day_post_inf_fact * seq_depth),
             data = .))) -> sectioned_shannon_lm

sectioned_shannon_lm
```

**shannon entropy general linear model**
```{r}
## and just with diet in general 
shannon_biom %>%
  do(tidy(lm(shannon_entropy ~ diet + (day_post_inf_fact * seq_depth),
             data = .))) -> shannon_lm

shannon_lm
```



