---
title: "tss_core_outputs"
author: "Madi"
date: "2023-05-16"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(qiime2R)
library(tidyverse)
library(cowplot)
library(magrittr)
library(vegan)
library(viridis)
library(microshades)
library(phyloseq)
library(ggh4x)
library(broom)
```

**Basic File-Prep Functions**
```{r}
metadata_fixer <- function(metadata_fp) {
  tmpMeta <- read_tsv(metadata_fp, n_max = 2)
  mycols <- colnames(tmpMeta)
  metadata <- read_tsv(metadata_fp, skip = 2, col_names = mycols)
  names(metadata)[names(metadata) == '#SampleID'] <- 'sampleid'
  metadata %>% 
    filter(!is.na(diet)) %>% 
    mutate(day_post_inf = if_else(day_post_inf == 2, 3, day_post_inf)) %>% 
    mutate(diet = as.factor(diet)) %>% 
    select(sampleid, day_post_inf, study, diet, mouse_id) -> metadata
  return(metadata)
}

## for faith's pd or any qiime output files that need the same second row exclusion as the metadata file
file_fixer <- function(metadata_fp) {
  tmpMeta <- read_tsv(metadata_fp, n_max = 2)
  mycols <- colnames(tmpMeta)
  metadata <- read_tsv(metadata_fp, skip = 2, col_names = mycols)
  names(metadata)[names(metadata) == '#SampleID'] <- 'sampleid'
  return(metadata)
}


## this function will pull out the percent variations from a specified column so you can add it to your pcoa plots 
pcoa_ax_lab <- function(unifrac_var, col_name){
  uni_lab <- as.character(round(unifrac_var[col_name] * 100, 2))
  uni_lab <- paste0(col_name, ' - ', uni_lab, '%')
  return(uni_lab)
}

## unweighted/weighted unifrac pcoa result, faith's pd, and shannon entropy file prep 
## going to attempt to return multiple outputs so I can just have one function for file prep
biom_table_prep <- function(unweighted_fp,
                            weighted_fp,
                            faith_fp,
                            shannon_fp,
                            metadata_file){
  ## unweighted pcoa
  unweighted <- read_qza(unweighted_fp)$data
  unweighted_var <- unweighted$ProportionExplained
  unweighted_pcoa <- unweighted$Vectors ##used for pcoa plot
  names(unweighted_pcoa)[names(unweighted_pcoa) == 'SampleID'] <- 'sampleid'
  ## weighted pcoa
  weighted <- read_qza(weighted_fp)$data
  weighted_var <- weighted$ProportionExplained
  weighted_pcoa <- weighted$Vectors
  names(weighted_pcoa)[names(weighted_pcoa) == 'SampleID'] <- 'sampleid'
  ## faith's 
  faith <- read_tsv(faith_fp)
  names(faith)[names(faith) == '#SampleID'] <- 'sampleid'
  ## shannon 
  shannon <- read_tsv(shannon_fp)
  names(shannon)[names(shannon) == '...1'] <- 'sampleid'
  ## unweighted biom 
  unweighted_pcoa %>% 
    left_join(metadata_file, by = 'sampleid') %>% 
    left_join(faith, by = 'sampleid') %>% 
    left_join(shannon, by = 'sampleid') -> unweighted_biom
  ## weighted biom
  weighted_pcoa %>% 
    left_join(metadata_file, by = 'sampleid') %>% 
    left_join(faith, by = 'sampleid') %>% 
    left_join(shannon, by = 'sampleid') -> weighted_biom
  ## creating a list to return multiple outputs 
  my_list <- list(UnweightedVar = unweighted_var, 
                  WeightedVar = weighted_var,
                  UnweightedBiom = unweighted_biom,
                  WeightedBiom = weighted_biom)
  return(my_list)
}

```

**Alpha Diversity Plots Functions**
```{r}
## faith's pd plot 
## assumes that the files is a .tsv
faith_pd_plot <- function(faith_fp,
                          metadata_file,
                          labels,
                          names_labels,
                          title){
  faith <- read_tsv(faith_fp)
  names(faith)[names(faith) == '#SampleID'] <- 'sampleid'
  metadata_file %>% 
    left_join(faith, by = 'sampleid') -> faith_pd
  ## what you want the grid labels to be (list)
  labs <- (labels) 
  ## what grid labels currently are (list)
  names(labs) <- (names_labels) 
  faith_pd %>%
    filter(!is.na(diet)) %>% 
    ggplot(aes(x = day_post_inf, y = faith_pd)) +
    geom_boxplot(aes(group = day_post_inf), outlier.shape = NA) +
    geom_jitter(width = 0.1, height = 0, alpha = 0.4) +
    scale_x_continuous(breaks = c(-15, -8, -3, 0, 3)) +
    geom_smooth(se = FALSE) +
    theme_bw(base_size = 16) +
    facet_grid(~diet, labeller = labeller(diet = labs) ) +
    ggtitle(title) +
    xlab('Days Relative to Infection') +
    ylab("Faith's PD") -> faith_plot
  return(faith_plot)
}

## shannon entropy plot
## assumes that the file is a .tsv
shannon_plot <- function(shannon_fp,
                          metadata_file,
                          labels,
                          names_labels,
                          title){
  shannon <- read_tsv(shannon_fp)
  names(shannon)[names(shannon) == '...1'] <- 'sampleid'
  metadata_file %>% 
    left_join(shannon, by = 'sampleid') -> shannon_entropy
  ## what you want the grid labels to be (list)
  labs <- (labels) 
  ## what grid labels currently are (list)
  names(labs) <- (names_labels) 
  shannon_entropy %>%
    filter(!is.na(diet)) %>% 
    ggplot(aes(x = day_post_inf, y = shannon_entropy)) +
    geom_boxplot(aes(group = day_post_inf), outlier.shape = NA) +
    geom_jitter(width = 0.1, height = 0, alpha = 0.4) +
    scale_x_continuous(breaks = c(-15, -8, -3, 0, 3)) +
    geom_smooth(se = FALSE) +
    theme_bw(base_size = 16) +
    facet_grid(~diet, labeller = labeller(diet = labs) ) +
    ggtitle(title) +
    xlab('Days Relative to Infection') +
    ylab("Shannon Entropy") -> shannon_plot
  return(shannon_plot)
}
```

**Beta Diversity Plot Function**
```{r}
## pcoa plot function
## xlab and ylab are outputs from pcoa_ax_lab function
pcoa_plot <- function(biom_file,
                      labels,
                      names_labels,
                      xlab,
                      ylab,
                      title){
  ## what you want the grid labels to be (list)
  labs <- (labels) 
  ## what grid labels currently are (list)
  names(labs) <- (names_labels) 
  biom_file %>% 
    filter(!is.na(diet)) %>% 
    ggplot(aes(x = PC1, y = PC2)) +
    geom_point(aes(fill = faith_pd), pch = 21, alpha = 0.7) +
    theme_bw(base_size = 14) +
    scale_fill_distiller(palette = 'Spectral', name = "Faith's PD") +
    facet_grid(day_post_inf~diet, 
               labeller = labeller(diet = labs)) +
    theme(legend.text = element_text(size = 8.5),
          strip.text.y = element_text(angle = 0)) +
    ggtitle(title) +
    labs(x = xlab, y = ylab) -> pcoa
  return(pcoa)
}
```

**Microshades Taxa Barplot Functions**
```{r}
## phyloseq input file prep (bc phyloseq is really nit-picky)
## metadata prep 
## make sure that you change the 'read' functions depending on whether you
## have a 'tsv' or a 'csv' 
metadata_prep <- function(metadata_fp) {
  tmpMeta <- read_tsv(metadata_fp, n_max = 2)
  mycols <- colnames(tmpMeta)
  metadata <- read_tsv(metadata_fp, skip = 2, col_names = mycols)
  names(metadata)[names(metadata) == '#SampleID'] <- 'sampleid'
  metadata %>% 
    filter(!is.na(diet)) %>% 
    mutate(day_post_inf = if_else(day_post_inf == 2, 3, day_post_inf)) -> metadata
  metadata <- as.data.frame(metadata)
  rownames(metadata) <- metadata$sampleid
  return(metadata)
}

## otu table prep with missing samples 
## assumes that you're reading in a 'tsv' file 
otu_phyloseq_prep <- function(otu_fp, missing_samples){
  otu_table <- read_tsv(file = otu_fp)
  otu_table %>% 
    gather(-asv, key = sample, value = count) %>% 
    filter(sample %in% missing_sample) %>% 
    spread(sample, count) -> otu_missing
  names(otu_missing)[names(otu_missing) == 'asv'] <- ' '
  otu_missing <- as.matrix(otu_missing)
  class(otu_missing) <- "numeric"
  return(otu_missing)
}

## tax table prep with missing samples 
## assumes that its a 'qza' file from qiime2
tax_table_prep <- function(taxonomy_fp, wanted_asvs){
  tax_table <- read_qza(taxonomy_fp)$data 
  tax_table %>% 
    parse_taxonomy() %>% 
    as_tibble(rownames = 'asv') %>%
    filter(asv %in% wanted_asvs) -> tax_missing
  names(tax_missing)[names(tax_missing) == 'asv'] <- ' '
  return(tax_missing)
}

## this assumes that you're reading in a qiime2 'qza' file
## this also doesn't filter out anything for you 
## but you usually shouldn't need the filtration steps
otu_prep <- function(otu_fp){
  otu_table <- read_qza(file = otu_fp)$data
  return(otu_table)
}

## this assumes that your input is a 'qza' file 
tax_prep <- function(tax_fp, otu_table){
  tax_table <- read_qza(file = tax_fp)$data %>% 
    parse_taxonomy()
  tax_table %>% 
    filter(rownames(tax_table) %in% rownames(otu_table)) -> tax_table
  return(tax_table)
}

## generating color palettes based on the phyloseq object you generated
## generate pseq like normal since there's already a nice function for it 
## just returns the color_objs_GP for you, you'll need to extract the mdf/cdf for the next function 
mdf_cdf_gp <- function(pseq, tax_table, tax_rank, tax_subgroup){
  pseq %>% 
  tax_glom(tax_subgroup) %>% 
    phyloseq::transform_sample_counts(function(x) {
     x/sum(x)
      }) %>% 
    psmelt() %>% 
  filter(Abundance > 0) -> mdf_prep
  phylum_table <- tax_glom(pseq, taxrank=tax_rank, ) %>% otu_table()
  phyla.otunames <- rownames(phylum_table)
  phylums <- tax_table(as.matrix(tax_table))[phyla.otunames,tax_rank]
  sorted_phylums <- phylums[order(rowSums(phylum_table), decreasing=T)]

## can take ranked phylums out if you don't have issues with top abund. phylums being repeated
## ranked_phylums <- sort(unique(sorted_phylums[40:1]))
  color_objs_GP <- create_color_dfs(mdf_prep,
                                 subgroup_level = tax_subgroup,
                                 selected_groups = sorted_phylums[5:1])
  return(color_objs_GP)
}

##functions for taxa barplot construction via microshades 
## should be able to edit this like ggplot to add title and axes specs. 
tax_barplot <- function(mdf_GP, cdf_GP, diet_labs){
  barplot <- plot_microshades(mdf_GP, cdf_GP)
  barplot_1 <- barplot + scale_y_continuous(labels = scales::percent, expand = expansion(0)) +
    theme_bw(base_size = 18) +
    theme(legend.position = "none") +
    theme(axis.text.x = element_blank()) +
    facet_grid2(day_post_inf~diet, scales="free_x", independent = "x",
               labeller = labeller(diet = diet_labs)) +
    theme(legend.text = element_text(size = 8.5),
        strip.text.y = element_text(angle = 0))
  return(barplot_1)
}

tax_barplot_legend <- function(mdf_GP, cdf_GP, tax_subgroup){
  GP_legend <-custom_legend(mdf_GP, cdf_GP, 
                          legend_key_size=unit(0.4, "cm"),
                          legend_text_size=15, subgroup_level=tax_subgroup)
  return(GP_legend)
}

## putting entire taxa barplot together
whole_tax_barplot <- function(tax_barplot, tax_barplot_legend){
  tax_all <- plot_grid(tax_barplot, tax_barplot_legend,  rel_widths = c(1, .25),
                       align = 'tblr',
                       axis = 'tblr')
  return(tax_all)
}

##the big function!!
microshades_tax_barplot <- function(meta_fp, 
                                    otu_fp, 
                                    tax_fp,
                                    tax_rank, 
                                    tax_subgroup,
                                    title_text, 
                                    y_text, 
                                    facet_labels){
  pseq_meta <- metadata_prep(meta_fp)
  pseq_otu <- otu_prep(otu_fp)
  pseq_tax <- tax_prep(tax_fp, pseq_otu)
  pseq <- phyloseq(otu_table(pseq_otu, taxa_are_rows = TRUE),
                 tax_table(as.matrix(pseq_tax)),
                 sample_data(pseq_meta))
  mdf_and_cdf <- mdf_cdf_gp(pseq, pseq_tax, tax_rank, tax_subgroup)
  mdf_GP <- mdf_and_cdf$mdf
  cdf_GP <- mdf_and_cdf$cdf
  main_barplot <- tax_barplot(mdf_GP, cdf_GP, facet_labels) +
    ggtitle(title_text) +
    ylab(y_text)
  legend <- tax_barplot_legend(mdf_GP, cdf_GP, tax_subgroup)
  whole_barplot <- whole_tax_barplot(main_barplot, legend)
  return(whole_barplot)
}
```

**File paths for all needed files**
Doing this so that I don't have to worry about re-entering entire file paths all the time, they'll just be at the beginning
```{r}
metadata_FP <- '../data/misc/merged_metadata1.tsv'
seq_depth_FP <- '../data/misc/tss_seq_depth.tsv'
unweighted_FP <- '../data/qiime/core_outputs/unweighted_unifrac_pcoa_results.qza'
weighted_FP <- '../data/qiime/core_outputs/weighted_unifrac_pcoa_results.qza'
faith_pd_FP <- '../data/qiime/core_outputs/faith_pd.tsv'
shannon_FP <- '../data/qiime/core_outputs/shannon_entropy.tsv'
tax_FP <- '../data/qiime/taxonomy.qza'
sample_asv_FP <- '../data/misc/tss_sample_asv.tsv'
otu_table_FP <- '../data/qiime/taxonomy_filtered.qza'
tss_tax_rank <- "Phylum"
tss_tax_subgroup <- "Family"
tss_title <- 'Total Sum Scaled Taxa Barplot'
tss_y <- 'Relative Abundance'

unwanted_samples <- c('Mock20220615A', 'Mock_1A', 'Mock_2A',
                      'Mock_3A', 'Mock_4A', 'Mock_5A', 'Mock_6A',
                      'Mock_7A', 'PCR Blank0',
                      'PCR Blank1', 'Mock_7', 'Mock_6',
                      'Mock_5', 'Mock_4', 'PCR blank')
diet_labs <- 
    c('Chow', 
      'High Fat / High Fiber', 
      'High Fat / Low Fiber', 
      'Low Fat / High Fiber', 
      'Low Fat / Low Fiber')

diet_names_labels <- c('Chow', 
                       'HF/HF', 
                       'HF/LF', 
                       'LF/HF', 
                       'LF/LF')
```

**Core Metrics File-Prep (for plots)**
```{r}
## metadata file prep
metadata <- metadata_fixer(metadata_FP)

## preparing core beta diversity files for ggplot
core_files <- biom_table_prep(unweighted_FP,
                              weighted_FP,
                              faith_pd_FP,
                              shannon_FP,
                              metadata)
## extracting core beta diversity files from named list 
uw_var <- core_files$UnweightedVar
w_var <- core_files$WeightedVar
unweighted_biom <- core_files$UnweightedBiom
weighted_biom <- core_files$WeightedBiom

```


**Unweighted PcoA plot**
```{r, fig.height=5, fig.width=12, warning=FALSE}
uw_uni_xlab <- pcoa_ax_lab(uw_var, 'PC1')
uw_uni_ylab <- pcoa_ax_lab(uw_var, 'PC2')

uw_title <- 'Total Sum Scaled Unweighted UniFrac'

unweighted_pcoa <- pcoa_plot(unweighted_biom,
                             diet_labs,
                             diet_names_labels,
                             uw_uni_xlab,
                             uw_uni_ylab,
                             uw_title)

unweighted_pcoa
```

**Weighted PcoA plot**
```{r, fig.height=5, fig.width=12, warning=FALSE}
w_uni_xlab <- pcoa_ax_lab(w_var, 'PC1')
w_uni_ylab <- pcoa_ax_lab(w_var, 'PC2')

w_title <- 'Total Sum Scaled Weighted UniFrac'

weighted_pcoa <- pcoa_plot(weighted_biom,
                             diet_labs,
                             diet_names_labels,
                             w_uni_xlab,
                             w_uni_ylab,
                             w_title)

weighted_pcoa
```

**Faith's PD plot**
```{r, warning=FALSE, fig.height=5, fig.width=10}
faith_title <- "Total Sum Scaled Faith's Phylogenic Diversity"

faith_plot <- faith_pd_plot(faith_pd_FP,
                            metadata,
                            diet_labs,
                            diet_names_labels,
                            faith_title)
faith_plot
```

**Shannon Entropy plot**
```{r, warning=FALSE, fig.height=5, fig.width=10}
shannon_title <- "Total Sum Scaled Shannon Entropy"

shannon_entropy_plot <- shannon_plot(shannon_FP,
                                     metadata,
                                     diet_labs,
                                     diet_names_labels,
                                     shannon_title)
shannon_entropy_plot
```

**Microshades Taxa Barplot**
Break up microshades function so that you get graphical outputs that you can edit rather than the whole barplot! This currently doesn't work because something in the microshades package is out of date and needs to be fixed by the authors. 
```{r, fig.width=25,fig.height=10}
tss_diet_labs <- 
    c('Chow', 
      'High Fat / High Fiber', 
      'High Fat / Low Fiber', 
      'Low Fat / High Fiber', 
      'Low Fat / Low Fiber')
names(tss_diet_labs) <- c('Chow', 
                          'HF/HF', 
                          'HF/LF', 
                          'LF/HF', 
                          'LF/LF')

## barplot function
tss_barplot <- microshades_tax_barplot(metadata_FP, 
                        otu_table_FP, 
                        tax_FP,
                        tss_tax_rank, 
                        tss_tax_subgroup,
                        tss_title, 
                        tss_y, 
                        tss_diet_labs) 

tss_barplot
```


**Preparation for the Microbe Family Relative Abundance plots**
Here I'm joining the taxonomic information with the relative abundances of each asv and the metadata file so I can create the plot below. 
```{r}
## actual taxonomic file 
tss_tax <- read_qza(tax_FP)$data %>% 
                    parse_taxonomy() %>% 
                    rownames_to_column('asv')

## reading in file that has the asvs matched with sample ids so I can link the taxonomic info to 
## my core diversity outputs 
# sample_asv <- read_tsv(sample_asv_FP)


## reading in otu table for relative abundance data 
tss_otu <- read_qza(otu_table_FP)$data

tss_otu %>% 
  as.tibble(rownames = 'asv') %>% 
  gather(-asv, key = sampleid, value = abun) %>% 
  filter(abun != 0) -> tss_otu

tss_otu %>% 
  left_join(metadata, by = 'sampleid') -> abun_table

abun_table %>% 
  left_join(tss_tax, by = 'asv') -> abun_table
```

**Microbe Family Relative Abundance Plot**
Here I plotted the relative abundances (I think) of the listed microbe families of interest below against diet and days post infection to see their change over time and if it follows expected trends. This is option #1 for visualizing this information. 
```{r, warning=FALSE, fig.height=10, fig.width=15}
wanted_family <- c('Enterobacteriaceae', 'Lactobacillaceae', 'Lachnospiraceae', 'Enterococcaceae',
                   'Staphylococcaceae', 'Tannerellaceae', 'Muribaculaceae', 'Bacteriodaceae', 
                   'Marinifilaceae')
abun_table %>% 
  filter(Family %in% wanted_family) %>% 
  mutate(mouse_fact = as.factor(mouse_id)) -> abun_filt

diet_labs <- 
    c('Chow', 
      'High Fat / High Fiber', 
      'High Fat / Low Fiber', 
      'Low Fat / High Fiber', 
      'Low Fat / Low Fiber')
names(diet_labs) <- c('Chow', 
                      'HF/HF', 
                      'HF/LF', 
                      'LF/HF', 
                      'LF/LF')

abun_filt %>%
  filter(!is.na(diet)) %>% 
  group_by(Family) %>% 
  ggplot(aes(x = day_post_inf, y = abun)) +
  scale_y_continuous(trans = 'log10') +
  scale_x_continuous(breaks = c(-15, -8, -3, 0, 3)) +
  geom_boxplot(aes(group = day_post_inf), outlier.shape = NA) +
  geom_smooth(method = 'loess', se = FALSE) +
  geom_jitter(width = 0.1, height = 0, alpha = 0.4) +
  theme_bw(base_size = 16) +
  facet_grid(Family~diet, labeller = labeller(diet = diet_labs)) +
  theme(strip.text.y = element_text(angle = 0)) +
  ggtitle("Microbe Family Relative Abundance") +
  ylab("Relative Abundance") +
  xlab("Days Relative to Infection") -> family_abun1

family_abun1
```


Option #2 for tracking the relative abundances of microbe families of interest over the course of time. I attempted to create a heat map that allows the relative abundances of microbe families to be easily trackable over time. The line graph I created above probably looks a bit better but I like the heat map concept. 
```{r, warning=FALSE, fig.height=10, fig.width=25}
abun_filt %>%
  filter(!is.na(diet)) %>% 
  ggplot(aes(x = mouse_fact, y = Family)) +
  geom_tile(aes(fill = abun), alpha = 0.5) +
  scale_fill_viridis(option = "H", name = 'Relative\nAbundance') +
  theme_bw(base_size = 16) +
  facet_grid(day_post_inf~diet, scales = 'free',
             labeller = labeller(diet = diet_labs)) +
  theme(strip.text.y = element_text(angle = 0),
        axis.text.x = element_blank()) + 
  xlab("Mouse ID") -> family_abun2

family_abun2
```


**Saving my plot outputs**
These go to the plots directory. 
```{r}
## microbe family relative abundance plots
## option #1
ggsave("family_abun1.pdf",
       plot = family_abun1, 
       width = 15, 
       height = 10, 
       path = '../plots')
## option #2
ggsave("family_abun2.pdf",
       plot = family_abun2, 
       width = 25, 
       height = 10, 
       path = '../plots')
```




