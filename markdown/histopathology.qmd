---
title: "histology"
format: html
editor: visual
---

```{r, include=FALSE}
library(broom)
library(cowplot)
library(magrittr)
library(qiime2R)
library(tidyverse)
```

**Basic Functions**

```{r}
## lists to redo the diet names on the facet labels of the ggplot created below 
diet_labs <- 
    c('Chow', 
      'High Fat / High Fiber', 
      'High Fat / Low Fiber', 
      'Low Fat / High Fiber', 
      'Low Fat / Low Fiber')

names(diet_labs) <- c('Chow', 'HF/HF', 'HF/LF', 'LF/HF', 'LF/LF')

## general function to prep the metadata file for further data analyses 
metadata_fixer <- function(metadata_fp) {
  tmpMeta <- read_tsv(metadata_fp, n_max = 2)
  mycols <- colnames(tmpMeta)
  metadata <- read_tsv(metadata_fp, skip = 2, col_names = mycols)
  names(metadata)[names(metadata) == '#SampleID'] <- 'sampleid'
  metadata %>% 
    filter(!is.na(diet)) %>% 
    mutate(day_post_inf = if_else(day_post_inf == 2, 3, day_post_inf)) %>% 
    mutate(diet = as.factor(diet)) -> metadata
  return(metadata)
}

## for editing my metadata file post metadata fixer 
meta_diet_fixer <- function(metadata_file,
                            seq_depth_fp){
  seq_depths <- read_tsv(seq_depth_fp)
  metadata_file %>% 
    select(sampleid, diet, day_post_inf, mouse_id, study) %>% 
    mutate(diet_true = diet,
    diet_true = if_else(day_post_inf == -15, "Chow", diet_true),
    high_fat = case_when(
      diet_true == 'HF/HF' ~ 1,
      diet_true == 'HF/LF' ~ 1,
      .default = 0
      ), 
      high_fiber = case_when(
      diet_true == 'HF/HF' ~ 1,
      diet_true == 'LF/HF' ~ 1,
      diet_true == 'Chow' ~ 1,
      .default = 0
      ), 
      purified_diet = case_when(
      diet_true == 'Chow' ~ 0,
      .default = 1
      )
    ) %>% 
    left_join(seq_depths) -> metadata
  return(metadata)
}
```

**File Paths**

```{r}
metadata_FP <- '../data/misc/merged_metadata1.tsv'
seq_depth_FP <- '../data/misc/tss_seq_depth.tsv'
histo_FP <- '../data/misc/histo_data.csv'
```

**Reading in Metadata and Histopathology Files**

the bulk of the histopathology scores are from mice that died before day 3

```{r}
metadata <- metadata_fixer(metadata_FP)

meta_filt <- meta_diet_fixer(metadata,
                            seq_depth_FP)

histo <- read_csv(histo_FP) %>% 
  filter(!is.na(mouse_id))

wanted_ids <- histo$mouse_id

## joining them all together for ggplot rendering 
## day 3 mice only histopathology scores 
## this one doesn't need a distinct command since the points are only from day 3 and there aren't 
## any repeating mouse ids
meta_filt %>% 
  filter(mouse_id %in% wanted_ids) %>% 
  left_join(histo, by = 'mouse_id') %>% 
  filter(day_post_inf == 3) %>% 
  gather(cecum, colon, key = tissue, value = score) -> histo_day3

## pulling mouse ids for day 3 mice out to filter out of the pre-day3 mouse table 
omit_mouse <- histo_day3$mouse_id

## all mouse histopathology scores that are not for day 3 mice (i.e. the mice that
## died before day 3)
## how do I keep the points from repeating without affecting the diet statisitcal coding???
histo %>% 
  filter(!(mouse_id %in% omit_mouse)) -> histo_preDay3_only

preDay3_mouse <- histo_preDay3_only$mouse_id

meta_filt %>% 
  filter(mouse_id %in% preDay3_mouse) %>% 
  left_join(histo_preDay3_only, by = 'mouse_id') %>% 
  gather(cecum, colon, key = tissue, value = score) %>% 
  group_by(mouse_id) %>% 
  filter(day_post_inf == max(day_post_inf)) -> histo_pre_day3
```

**Histopathology Kruskal-Wallis and Dunn's Post Hoc test**

need to run these statistical tests to put them onto the ggplots!

```{r}
## day 3 mouse histopathology stats
## kruskal wallis test 
histo_day3 %>% 
  group_by(tissue) %>% 
  do(tidy(kruskal.test(score ~ diet,
             data = .))) -> day3_kruskal

## dunns post hoc test 
histo_day3 %>% 
  group_by(tissue) %>% 
  dunn_test(score ~ diet,
            p.adjust.method = 'BH',
            data = .) %>% 
  add_y_position(scales = 'free_y') -> day3_dunn

## pre-day 3 mouse histopathology stats
## kruskal wallis test 
histo_pre_day3 %>% 
  group_by(tissue) %>% 
  do(tidy(kruskal.test(score ~ diet,
                       data = .))) -> pre_day3_kruskal

## dunns post hoc test 
histo_pre_day3 %>% 
  group_by(tissue) %>% 
  dunn_test(score ~ diet,
            p.adjust.method = 'BH',
            data = .) %>% 
  add_y_position(scales = 'free_y') -> pre_day3_dunn
```

**Histopathology Plot**

histopathology plot for day 3 mice only!!

```{r, warning=FALSE, fig.height=5, fig.width=9}
tissue_labs <- c('Cecum',
                 'Colon')
names(tissue_labs) <- c('cecum',
                        'colon')

histo_day3 %>% 
  group_by(sampleid) %>% 
  ggplot(aes(x = diet, y = score)) +
  geom_violin(aes(group = diet)) +
  geom_jitter(alpha = 0.4, width = 0.1, height = 0) +
  scale_x_discrete(labels = c('Chow', 'High Fat/\nHigh Fiber', 'High Fat/\nLow Fiber',
                              'Low Fat/\nHigh Fiber', 'Low Fat/\nLow Fiber')) +
  facet_wrap(~tissue, labeller = labeller(tissue = tissue_labs),
             scales = "free_y") +
  stat_pvalue_manual(day3_dunn,
                     tip.length = 0.01,
                     label = 'p.adj.signif',
                     hide.ns = TRUE) +
  theme_bw(base_size = 14) +
  xlab('Diet') +
  ylab('Histopathology Score') +
  ggtitle("Histopathology Score by Diet for Day 3 Mice") -> histo_day3_plot

histo_day3_plot
```

histopathology scores for all mice that died before day 3!!

```{r, warning=FALSE, fig.height=6, fig.width=9}
histo_pre_day3 %>% 
  group_by(sampleid) %>% 
  ggplot(aes(x = diet, y = score)) +
  geom_violin(aes(group = diet), outlier.shape = NA) +
  geom_jitter(alpha = 0.4, width = 0.1, height = 0) +
  scale_x_discrete(labels = c('Chow', 'High Fat/\nHigh Fiber', 'High Fat/\nLow Fiber',
                              'Low Fat/\nHigh Fiber', 'Low Fat/\nLow Fiber')) +
  facet_wrap(~tissue, labeller = labeller(tissue = tissue_labs),
             scales = "free_y") +
  stat_pvalue_manual(pre_day3_dunn,
                     tip.length = 0.01,
                     label = 'p.adj.signif',
                     hide.ns = TRUE) +
  theme_bw(base_size = 14) +
  xlab('Diet') +
  ylab('Histopathology Score') +
  ggtitle("Histopathology Score by Diet for Pre-Day 3 Mice") -> histo_pre_day3_plot

histo_pre_day3_plot
```

**Histopathology Linear Modeling**

this is for all the histopathology scores only for day 3 mice (histopathology scores are for all mice, even the ones that died).

```{r}
histo_day3 %>% 
  group_by(tissue) %>% 
  do(tidy(lm(score ~ purified_diet + high_fat + high_fiber,
             data = .))) -> histo_day3_results

histo_day3_results
```

these are histopathology scores for all mice that died before day 3 and the associated stats.

```{r}
histo_pre_day3 %>% 
  group_by(tissue) %>% 
  do(tidy(lm(score ~ purified_diet + high_fat + high_fiber,
             data = .))) -> histo_pre_day3_results

histo_pre_day3_results
```

**Saving Plot and Stats**

```{r}
ggsave("histopathology_day3.pdf", 
       plot = histo_day3_plot,
       width = 9, 
       height = 5,
       path = '../plots')
ggsave("histopathology_pre_day3.pdf", 
       plot = histo_pre_day3_plot,
       width = 9, 
       height = 6,
       path = '../plots')
write_tsv(day3_dunn,
          '../stats/histopathology_day3.tsv')
write_tsv(pre_day3_dunn,
          '../stats/histopathology_pre_day3.tsv')
```
