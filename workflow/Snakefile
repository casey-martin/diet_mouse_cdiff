rule target:
    input:
        "data/qiime/total_sum_scaling.tsv",
        "data/misc/tss_seq_depth.tsv",
        "data/misc/processed_metadata.tsv",
        "plots/unweighted_unifrac_pcoa.pdf",
        "plots/weighted_unifrac_pcoa.pdf",
        "stats/w_adonis_results.tsv",
        "stats/uw_adonis_results.tsv",
        "plots/faith_pd.pdf",
        "plots/shannon_entropy.pdf",
        "stats/faith_total_results.tsv",
        "stats/faith_diet_results.tsv",
        "stats/shannon_total_results.tsv",
        "stats/shannon_diet_results.tsv",
        "stats/wu_homogeneity.tsv",
        "stats/uu_homogeneity.tsv",
        "plots/wu_homogeneity.pdf",
        "plots/uu_homogeneity.pdf",
        "stats/uu_resiliency.tsv",
        "stats/wu_resiliency.tsv",
        "plots/wu_resiliency.pdf",
        "plots/uu_resiliency.pdf",
        "plots/butyrate_kinase.pdf",
        "plots/butyryl_coa_transferase.pdf",
        "plots/baiH.pdf",
        "plots/baiI.pdf"



rule total_sum_scaling:
    input:
        biom_fp = "data/misc/euk_filt_mergedDietAim1table_051523-Copy1.qza",
        lacto_asv_fp = "data/misc/lactoOnlydna-sequences.fasta"
    output:
        "data/qiime/total_sum_scaling.tsv"
    shell:
        """
        Rscript scripts/total_sum_scaling.R
        """


rule sequencing_depth_calculation:
    input:
        biom_fp = "data/misc/euk_filt_mergedDietAim1table_051523-Copy1.qza",
        lacto_asv_fp = "data/misc/lactoOnlydna-sequences.fasta"
    output:
        "data/misc/tss_seq_depth.tsv"
    shell:
        """
        Rscript scripts/seq_depth.R
        """


rule metadata_processing:
    input:
        metadata_FP = "data/misc/merged_metadata1.tsv",
        seq_depth_FP = "data/misc/tss_seq_depth.tsv"
    output:
        "data/misc/processed_metadata.tsv"
    shell:
        """
        Rscript scripts/metadata_processing.R
        """


rule alpha_diversity_plots:
    input:
        metadata_FP = "data/misc/processed_metadata.tsv",
        faith_pd_FP = "data/qiime/core_outputs/faith_pd.tsv",
        shannon_FP = "data/qiime/core_outputs/shannon_entropy.tsv"
    output:
        "plots/faith_pd.pdf",
        "plots/shannon_entropy.pdf"
    shell:
        """
        Rscript scripts/alpha_div_plots.R
        """


rule alpha_diversity_stats:
    input:
        metadata_FP = "data/misc/processed_metadata.tsv",
        faith_pd_fp = "data/qiime/core_outputs/faith_pd.tsv",
        shannon_fp = "data/qiime/core_outputs/shannon_entropy.tsv"
    output:
        "stats/faith_total_results.tsv",
        "stats/faith_diet_results.tsv",
        "stats/shannon_total_results.tsv",
        "stats/shannon_diet_results.tsv"
    shell:
        """
        Rscript scripts/alpha_div_stats.R
        """


rule beta_diversity_plots:
    input:
        metadata_FP = "data/misc/processed_metadata.tsv",
        unweighted_FP = "data/qiime/core_outputs/unweighted_unifrac_pcoa_results.qza",
        weighted_FP = "data/qiime/core_outputs/weighted_unifrac_pcoa_results.qza"
    output:
        "plots/unweighted_unifrac_pcoa.pdf",
        "plots/weighted_unifrac_pcoa.pdf"
    shell:
        """
        Rscript scripts/beta_div_plots.R
        """


rule beta_diversity_stats:
    input:
        metadata_FP = "data/misc/processed_metadata.tsv",
        uw_dist_fp = "data/qiime/core_outputs/uw_dist_matrix.tsv",
        w_dist_fp = "data/qiime/core_outputs/w_dist_matrix.tsv"
    output:
        "stats/w_adonis_results.tsv",
        "stats/uw_adonis_results.tsv"
    shell:
        """
        Rscript scripts/beta_div_stats.R
        """


rule homogeneity:
    input:
        metadata_FP = "data/misc/processed_metadata.tsv",
        uu_dist_fp = "data/qiime/core_outputs/uw_dist_matrix.tsv",
        wu_dist_fp = "data/qiime/core_outputs/w_dist_matrix.tsv"
    output:
        "stats/wu_homogeneity.tsv",
        "stats/uu_homogeneity.tsv",
        "plots/wu_homogeneity.pdf",
        "plots/uu_homogeneity.pdf"
    shell:
        """
        Rscript scripts/homog_calc.R
        """


rule resiliency:
    input:
       metadata_FP = "data/misc/processed_metadata.tsv",
       uu_dist_fp = "data/qiime/core_outputs/uw_dist_matrix.tsv",
       wu_dist_fp = "data/qiime/core_outputs/w_dist_matrix.tsv"
    output:
        "stats/uu_resiliency.tsv",
        "stats/wu_resiliency.tsv",
        "plots/wu_resiliency.pdf",
        "plots/uu_resiliency.pdf"
    shell:
        """
        Rscript scripts/resil_calc.R
        """


rule butyrate_plots:
    input:
        metadata_FP = "data/misc/processed_metadata.tsv",
        tax_FP = "data/qiime/taxonomy.qza",
        ko_contrib_FP = "data/picrust/tss3_meta_contrib.tsv"
    output:
        "plots/butyrate_kinase.pdf",
        "plots/butyryl_coa_transferase.pdf"
    shell:
        """
        Rscript scripts/butyrate_plots.R
        """


rule bile_acid_plots:
    input:
       metadata_FP = "data/misc/processed_metadata.tsv",
       tax_FP = "data/qiime/taxonomy.qza",
       ko_contrib_FP = "data/picrust/tss3_meta_contrib.tsv"
    output:
        "plots/baiH.pdf",
        "plots/baiI.pdf"
    shell:
        """
        Rscript scripts/bile_acid_plots.R
        """